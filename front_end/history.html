<!DOCTYPE html>
<html>
<head>
    <title>Medical History</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
<div class="app-navbar">
    <div class="app-brand">üè• City Hospital</div>
    <div class="app-nav-right">
        <button id="navBackBtn" class="secondary" onclick="location.href = 'patient-dashboard.html'">‚Üê Back</button>
    </div>
</div>

<div class="page-container">

<div class="soft-card" style="max-width:900px; margin:auto;">
    <h3>üìÇ Medical History</h3>
    
    <button id="backBtn" class="secondary" style="width:auto; margin-bottom:20px;" onclick="location.href = 'patient-dashboard.html'">‚Üê Back</button>
    
    <div id="historyList">Loading...</div>
</div>
</div>

<div id="print-template" style="display:none;">
    
    <div>
        <div style="display:flex; justify-content:space-between; align-items:flex-start; border-bottom: 3px solid #2563EB; padding-bottom:15px;">
            <div>
                <h1 style="margin:0; font-size: 28px; color:#2563EB; text-transform:uppercase;">üè• City Hospital</h1>
                <p style="margin:5px 0 0 0; font-size:14px; color:#444;">
                    Medical District, Gandhinagar, Gujarat<br>
                    Ph: +91-9876****** | demo@cityhospital.com
                </p>
            </div>
            <div style="text-align:right;">
                <h3 style="margin:0; color:#444;">OPD PRESCRIPTION</h3>
                <p style="margin:5px 0 0 0; font-size:14px;">Doctor: <span id="printDocName"></span></p>
                <p style="margin:5px 0 0 0; font-size:14px;">Date: <span id="printDate"></span></p>
                <p style="margin:0; font-size:14px;">Rx ID: <span id="printID"></span></p>
                
            </div>
        </div>

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; background: #f8f9fa; padding: 15px; border-radius: 6px; border: 1px solid #ddd;">
            <div>
                <strong style="color:#666; font-size:12px; text-transform:uppercase;">Patient Name</strong>
                <div id="printName" style="font-size:18px; font-weight:bold; margin-top:2px;"></div>
            </div>
            <div>
                <strong style="color:#666; font-size:12px; text-transform:uppercase;">Age / Gender</strong>
                <div style="font-size:18px; font-weight:bold; margin-top:2px;">
                    <span id="printAge"></span> / <span id="printGender"></span>
                </div>
            </div>
            <div style="grid-column: span 2;">
                <strong style="color:#666; font-size:12px; text-transform:uppercase;">Diagnosis</strong>
                <div id="printDiagnosis" style="font-size:16px; margin-top:2px;"></div>
            </div>
        </div>

        <div style="margin-top: 30px;">
            <div style="font-size: 40px; font-weight: bold; font-family: serif; color: #2563EB;">‚Ñû</div>
            
            <table id="print-table">
                <thead>
                    <tr>
                        <th style="width: 40%;">Medicine Name</th>
                        <th style="width: 30%;">Dosage</th>
                        <th style="width: 30%;">Frequency</th>
                    </tr>
                </thead>
                <tbody id="printMedList">
                    </tbody>
            </table>
        </div>

        <div style="margin-top: 30px; border-left: 4px solid #ddd; padding-left: 15px;">
            <strong>üë®‚Äç‚öïÔ∏è Advice / Notes:</strong>
            <p id="printNotes" style="margin-top:5px; white-space: pre-wrap;"></p>
        </div>
    </div>

    <div style="margin-top: 50px;">
        <div style="display:flex; justify-content:space-between; align-items:flex-end;">
            
            <div style="text-align:center;">
                <div style="width:100px; height:80px; border:2px dashed #ccc; display:flex; align-items:center; justify-content:center; color:#ccc;">
                    Stamp
                </div>
            </div>

            <div style="text-align:right; min-width: 250px;">
                <div style="border-bottom: 2px solid #000; height: 40px;"></div>
                <p style="margin: 5px 0 0 0; font-weight: bold;">Doctor's Name & Signature</p>
                <small style="color:#666;">(Please sign above)</small>
            </div>
        </div>
        
        <div style="border-top: 1px solid #ddd; margin-top: 20px; padding-top: 10px; font-size: 10px; text-align: center; color: #888;">
            This document is generated by Hospital Management System. 
        </div>
    </div>
</div>

<script>
const API_URL =  "https://hospital-backend-ltiv.onrender.com";

// TEP 1: DETECT USER TYPE (Admin vs Patient)
const urlParams = new URLSearchParams(window.location.search);
const adminViewId = urlParams.get('id');
const uid = adminViewId || localStorage.getItem("user_id");

// STEP 2: CONFIGURE BACK BUTTON 
const backBtn = document.getElementById('backBtn');
document.getElementById("navBackBtn").onclick = backBtn.onclick;

if (adminViewId) {
    backBtn.innerText = "‚Üê Back to Admin Panel";
    backBtn.onclick = function() { location.href = 'admin.html'; };
    backBtn.style.border = "1px solid #4F46E5";
    backBtn.style.color = "#4F46E5";
} else {
    backBtn.innerText = "‚Üê Back to Dashboard";
    backBtn.onclick = function() { location.href = 'patient-dashboard.html'; };
}

// STEP 3: LOAD HISTORY DATA
async function loadHistory() {
    if(!uid) {
        alert("No Patient ID found.");
        if(adminViewId) location.href = 'admin.html';
        else location.href = 'patient-login.html';
        return;
    }

    try {
        const res = await fetch(`${API_URL}/patient/history/${uid}`);
        if (!res.ok) throw new Error(`Server status: ${res.status}`);

        const data = await res.json();
        const list = document.getElementById('historyList');

        if(data.length === 0) {
            list.innerHTML = "<p style='text-align:center; color:#666; margin-top:20px;'>No medical records found.</p>";
            return;
        }

        list.innerHTML = ""; 
        
        data.forEach(record => {
            let medHtml = "";
            try {
                let meds = [];
                if (typeof record.medicines === 'string') {
                    meds = JSON.parse(record.medicines);
                } else if (Array.isArray(record.medicines)) {
                    meds = record.medicines;
                }

                if (meds.length > 0) {
                    medHtml = meds.map(m => `<li><b>${m.name}</b> (${m.dose}) - ${m.freq}</li>`).join('');
                } else {
                    medHtml = "<li>No medicines prescribed.</li>";
                }
            } catch (e) {
                console.warn("Error parsing medicines", e);
                medHtml = `<li style="color:red;">Error loading medicine data.</li>`;
            }

            list.innerHTML += `
            <div class="admin-card" style="margin-bottom:20px;">
                <div style="display:flex; justify-content:space-between; border-bottom:1px solid #eee; padding-bottom:10px; margin-bottom:10px;">
                    <span style="font-weight:bold; color:#4F46E5;">${new Date(record.visit_date).toLocaleDateString()}</span>
                    <span style="background:#EEF2FF; color:#4F46E5; padding:2px 8px; border-radius:10px; font-size:12px;">Rx #${record.id}</span>
                </div>
                
                <p><strong>Diagnosis:</strong> ${record.diagnosis || "General Checkup"}</p>
                <p><strong>Doctor:</strong> ${record.doctor_name || "General Doctor"}</p>
                
                <div style="background:#f9f9f9; padding:10px; border-radius:8px; margin:10px 0;">
                    <strong>üíä Medicines:</strong>
                    <ul style="margin:5px 0 0 20px; list-style:disc;">${medHtml}</ul>
                </div>
                
                <p style="font-size:14px; color:#666;"><strong>üë®‚Äç‚öïÔ∏è Note:</strong> ${record.notes || "--"}</p>

                <div style="text-align:right; margin-top:15px;">
                    <button onclick='printPrescription(${JSON.stringify(record).replace(/'/g, "&#39;")})' class="btn-download" style="width:auto; padding:8px 15px;">
                        üìÑ Download PDF
                    </button>
                </div>
            </div>`;
        });

    } catch (err) {
        console.error("Error:", err);
        document.getElementById('historyList').innerHTML = `<p style="color:red; text-align:center;">Failed to load history.</p>`;
    }
}

function printPrescription(record) {
    // 1. Fill Data
    document.getElementById('printName').innerText = record.patient_name || "Unknown"; 
    document.getElementById('printAge').innerText = record.patient_age || "--";
    document.getElementById('printGender').innerText = record.gender || "";
    document.getElementById('printDate').innerText = new Date(record.visit_date).toLocaleDateString();
    document.getElementById('printID').innerText = "#" + record.id;
    document.getElementById('printDiagnosis').innerText = record.diagnosis;
    document.getElementById('printNotes').innerText = record.notes || "No specific advice.";
    
    // Fill Doctor Name
    document.getElementById('printDocName').innerText = record.doctor_name || "General Doctor";

    // 2. Fill Medicines
    let medHtml = "";
    try {
        let meds = (typeof record.medicines === 'string') ? JSON.parse(record.medicines) : record.medicines;
        if(meds.length > 0) {
            meds.forEach(m => {
                medHtml += `
                    <tr>
                        <td style="font-weight:bold;">${m.name}</td>
                        <td>${m.dose}</td>
                        <td>${m.freq}</td>
                    </tr>`;
            });
        } else {
             medHtml = `<tr><td colspan="3" style="text-align:center; padding:20px;">No medicines prescribed.</td></tr>`;
        }
    } catch(e) { 
        medHtml = `<tr><td colspan="3">Error loading medicines</td></tr>`; 
    }

    document.getElementById('printMedList').innerHTML = medHtml;

    // 3. Trigger Print
    window.print();
}

// Start
loadHistory();
</script>
</body>
</html>